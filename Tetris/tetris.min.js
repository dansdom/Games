(function(){var p,q,u;function K(){function a(){v=(new Date).getTime();var b=Math.min(1,(v-B)/1E3);f?(m+=b,m>C&&(m-=C,w("down"))):m=0;D();B=v;n&&n.update();requestAnimationFrame(a,g)}document.getElementById("help").innerHTML="press enter to start";document.removeEventListener("keydown",L);document.addEventListener("keydown",L,!1);n&&(n.domElement.id="stats",document.getElementById("stats-holder").appendChild(n.domElement),n.setMode(0));B=v=(new Date).getTime();c=E();k=E();D();a()}function L(a){var b= !1;switch(a.keyCode){case l.enter:f||(x?(document.getElementById("help").innerHTML="GAME OVER",x=!1,document.getElementById("stats").remove(),f=!0,h={points:0,lines:0,level:0},q=u=p=!0,m=0,d=[],K()):(document.getElementById("help").innerHTML="press enter to start",f=!0),document.getElementById("help").innerHTML="Press esc to pause");b=!0;break;case l.esc:f=!1;document.getElementById("help").innerHTML="Press enter to start";b=!0;break;case l.up:M("clockwise");b=!0;break;case l.down:M("anticlockwise"); b=!0;break;case l.left:w("left");b=!0;break;case l.right:w("right");b=!0;break;case l.space:F=!0;N();b=!0;break;case l.q:f=!1,x=!0,document.getElementById("help").innerHTML="Press enter to start",y.clearRect(0,0,g.width,g.height),G.clearRect(0,0,r.width,r.height),document.getElementById("score").innerHTML="0",document.getElementById("lines").innerHTML="0",document.getElementById("level").innerHTML="0",b=!0}b&&a.preventDefault()}function H(a,b,e,I){var c=!1;J(e,a,b,I,function(a,b){if(0>a||12<=a)c= !0;if(0>b||20<=b)c=!0;d[b]&&d[b][a]&&(c=!0)});return c}function w(a){var b=c.x,e=c.y;switch(a){case "left":b--;break;case "right":b++;break;case "down":e++}H(b,e,c.type,c.state)?"down"===a&&(Q(c.type,c.x,c.y,c.state),F=!1):(c.x=b,c.y=e,p=!0)}function M(a){var b=c.state;switch(a){case "clockwise":b++;break;case "anticlockwise":b--}0>b&&(b=3);3<b&&(b=0);H(c.x,c.y,c.type,b)||(c.state=b,p=!0)}function N(){setTimeout(function(){F&&(w("down"),N())},15)}function R(){var a=[],b,e,c;for(e=0;e<d.length;e++){for(c= b=0;c<d[e].length;c++)d[e][c]&&b++;12===b&&a.push(e)}a.reverse();0<a.length&&(h.points+=100*Math.pow(2,a.length),h.lines++,h.level=Math.floor(h.lines/10),u=!0,C=1-.05*h.level);for(e=0;e<a.length;e++)d.splice(a[e],1);for(e=0;e<a.length;e++)d.unshift([])}function Q(a,b,e,I){J(a,b,e,I,function(b,c){d[c]=d[c]||[];d[c][b]=a});q=p=!0;c=k;k=E();R();D();H(k.x,k.y,k.type,k.state)&&(f=!1,x=!0,document.getElementById("help").innerHTML="GAME OVER")}function E(){var a=S,b;0===t.length&&(t=[a.I,a.I,a.I,a.I,a.J, a.J,a.J,a.J,a.L,a.L,a.L,a.L,a.O,a.O,a.O,a.O,a.S,a.S,a.S,a.S,a.T,a.T,a.T,a.T,a.Z,a.Z,a.Z,a.Z]);a=t.length;a=0+Math.floor(Math.random()*(a-0));b=t[a];t.splice(a,1);return{type:b,state:0,x:Math.round(0+Math.floor(10*Math.random())),y:0}}function J(a,b,c,d,f){a=a.states[d];for(var h=d=0,g=32768;0<g;g>>=1)g&a&&f(b+d,c+h),d++,3<d&&(d=0,h++)}function D(){if(f){var a,b;if(p)for(f&&y.clearRect(0,0,g.width,g.height),a=0;12>a;a++)for(d[a]=d[a]||[],b=0;20>b;b++)d[b]=d[b]||[],d[b][a]&&O(a,b,d[b][a].color,y);P(c.type, c.x,c.y,c.state,y);f&&q&&(G.clearRect(0,0,r.width,r.height),P(k.type,0,0,0,G),q=!1);f&&u&&(document.getElementById("score").innerHTML=h.points,document.getElementById("lines").innerHTML=h.lines,document.getElementById("level").innerHTML=h.level)}}function P(a,b,c,d,f){J(a,b,c,d,function(b,c){O(b,c,a.color,f)})}function O(a,b,c,d){d.fillStyle=c;d.fillRect(a*z,b*A,z,A);d.strokeStyle="white";d.strokeRect(a*z,b*A,z,A)}window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame|| window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1E3/60)});var g=document.getElementById("tetris"),y=g.getContext("2d"),r=document.getElementById("next-piece"),G=r.getContext("2d"),B,v,d=[],z=g.width/12,A=g.height/20,l={esc:27,space:32,left:37,up:38,right:39,down:40,enter:13,q:81},n;"function"==typeof Stats&&(n=new Stats);var S={I:{states:[8738,61440,8738,61440],color:"pink"},J:{states:[8800,36352,25664,57856],color:"green"}, L:{states:[17504,59392,25120,11776],color:"teal"},O:{states:[1632,1632,1632,1632],color:"blue"},S:{states:[27648,17952,27648,17952],color:"red"},T:{states:[58368,9760,1248,35968],color:"orange"},Z:{states:[50688,9792,3168,19584],color:"yellow"}},t=[],f=!1,C=1,c,k,m=0,h={points:0,lines:0,level:0},x=q=u=p=!0,F=!1;K()})();